<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Change Password - PrivateRAT v2.0</title>
  <link rel="stylesheet" href="/css/semantic.min.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/design-system.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <style>
    .password-container {
      max-width: 600px;
    }

    .password-strength {
      margin-top: 8px;
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      width: 0%;
      transition: all 0.3s;
      border-radius: 2px;
    }

    .password-strength-bar.weak {
      width: 33%;
      background: #e53e3e;
    }

    .password-strength-bar.medium {
      width: 66%;
      background: #ed8936;
    }

    .password-strength-bar.strong {
      width: 100%;
      background: #48bb78;
    }

    .password-requirements {
      margin-top: 16px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 10px;
      font-size: 13px;
      color: #718096;
    }

    .password-requirements ul {
      margin: 8px 0 0 20px;
      padding: 0;
    }

    .password-requirements li {
      margin-bottom: 4px;
    }

    .password-requirements li.valid {
      color: #48bb78;
    }
  </style>
  <script src="/js/jquery-3.4.1.min.js"></script>
  <script src="/js/semantic.min.js"></script>
</head>
<body>
  <button class="mobile-toggle" onclick="toggleSidebar()">
    <i class="bars icon"></i>
  </button>

  <div class="app-container">
    <%- include('partials/sidebar.ejs', { activePage: 'changepass' }) %>

    <div class="main-content">
      <div class="page-header">
        <h1 class="page-title">Change Password</h1>
        <p class="page-subtitle">Update your account password for better security</p>
      </div>

      <div class="password-container">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="lock icon"></i> Password Settings</h3>
          </div>
          <div class="card-body">
            <form id="passwordForm" method="POST" action="/changepass">
              <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password" required>
              </div>
              <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" id="newPassword" class="form-input" placeholder="Enter new password" required>
                <div class="password-strength">
                  <div class="password-strength-bar" id="strengthBar"></div>
                </div>
                <div class="password-requirements">
                  <strong>Password Requirements:</strong>
                  <ul>
                    <li id="req-length">At least 8 characters</li>
                    <li id="req-uppercase">One uppercase letter</li>
                    <li id="req-lowercase">One lowercase letter</li>
                    <li id="req-number">One number</li>
                  </ul>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm new password" required>
                <div id="passwordMatch" style="margin-top: 8px; font-size: 13px; display: none;"></div>
              </div>
              <div style="margin-top: 24px; display: flex; gap: 16px;">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                  <i class="save icon"></i> Change Password
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                  <i class="refresh icon"></i> Reset
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('open');
    }

    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const mobileToggle = document.querySelector('.mobile-toggle');
      if (window.innerWidth <= 768 && 
          !sidebar.contains(event.target) && 
          !mobileToggle.contains(event.target)) {
        sidebar.classList.remove('open');
      }
    });

    function checkPasswordStrength(password) {
      let strength = 0;
      const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password)
      };

      document.getElementById('req-length').classList.toggle('valid', requirements.length);
      document.getElementById('req-uppercase').classList.toggle('valid', requirements.uppercase);
      document.getElementById('req-lowercase').classList.toggle('valid', requirements.lowercase);
      document.getElementById('req-number').classList.toggle('valid', requirements.number);

      Object.values(requirements).forEach(req => {
        if (req) strength++;
      });

      const strengthBar = document.getElementById('strengthBar');
      strengthBar.className = 'password-strength-bar';
      if (strength <= 1) {
        strengthBar.classList.add('weak');
      } else if (strength <= 2) {
        strengthBar.classList.add('medium');
      } else if (strength === 4) {
        strengthBar.classList.add('strong');
      }
    }

    function checkPasswordMatch() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const matchDiv = document.getElementById('passwordMatch');

      if (confirmPassword.length === 0) {
        matchDiv.style.display = 'none';
        return;
      }

      matchDiv.style.display = 'block';
      if (newPassword === confirmPassword) {
        matchDiv.innerHTML = '<i class="check circle icon" style="color: #48bb78;"></i> Passwords match';
        matchDiv.style.color = '#48bb78';
      } else {
        matchDiv.innerHTML = '<i class="times circle icon" style="color: #e53e3e;"></i> Passwords do not match';
        matchDiv.style.color = '#e53e3e';
      }
    }

    document.getElementById('newPassword').addEventListener('input', function() {
      checkPasswordStrength(this.value);
      checkPasswordMatch();
    });

    document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

    document.getElementById('passwordForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        alert('Passwords do not match!');
        return;
      }

      if (newPassword.length < 8) {
        alert('Password must be at least 8 characters long!');
        return;
      }

      // Submit form
      const formData = new FormData();
      formData.append('pass', newPassword);

      fetch('/changepass', {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(data => {
        if (data === '200') {
          alert('Password changed successfully!');
          resetForm();
        } else {
          alert('Failed to change password. Please try again.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    });

    function resetForm() {
      document.getElementById('passwordForm').reset();
      document.getElementById('strengthBar').className = 'password-strength-bar';
      document.getElementById('passwordMatch').style.display = 'none';
      ['req-length', 'req-uppercase', 'req-lowercase', 'req-number'].forEach(id => {
        document.getElementById(id).classList.remove('valid');
      });
    }
  </script>
</body>
</html>
